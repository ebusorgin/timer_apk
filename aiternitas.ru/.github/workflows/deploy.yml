name: Deploy Aiternitas Main to Production

on:
  push:
    branches:
      - production
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Aiternitas Main to aiternitas.ru
    runs-on: ubuntu-latest
    env:
      SSH_HOST: ${{ secrets.SERVER_HOST || '82.146.44.126' }}
      SSH_USER: ${{ secrets.SERVER_USER || 'root' }}
      SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check required secrets
        shell: bash
        run: |
          if [ -z "$SSH_KEY" ]; then
            echo "‚ö†Ô∏è  SSH_PRIVATE_KEY secret is not set. Deployment steps will be skipped."
            echo "skip_deploy=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_deploy=false" >> "$GITHUB_OUTPUT"
          fi
        id: secrets_check

      - name: Setup SSH key
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Aiternitas Main
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        run: |
          set -e
          SSH_HOST="${{ env.SSH_HOST }}"
          SSH_USER="${{ env.SSH_USER }}"
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} <<'EOSSH'
            set -e
            
            REPO_DIR="/opt/aiternitas-main"
            
            echo "=== Deployment Info ==="
            echo "Repository directory: $REPO_DIR"
            echo "Current directory: $(pwd)"
            echo ""
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if [ ! -d "$REPO_DIR" ]; then
              echo "Creating directory $REPO_DIR..."
              mkdir -p "$REPO_DIR"
              cd "$REPO_DIR"
              git init
              git remote add origin git@github.com:ebusorgin/aiternitas.ru.git || true
            fi
            
            cd "$REPO_DIR"
            git config --global --add safe.directory "$REPO_DIR" || true
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º remote
            REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")
            echo "Remote origin: ${REMOTE_URL:-not configured}"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo ""
            echo "=== Updating code ==="
            git fetch origin || {
              echo "‚ö†Ô∏è  Failed to fetch. Checking if repository is initialized..."
              if [ -z "$REMOTE_URL" ]; then
                git remote add origin git@github.com:ebusorgin/aiternitas.ru.git
                git fetch origin || {
                  echo "‚ùå Failed to fetch from origin. Check SSH keys on server."
                  exit 1
                }
              else
                echo "‚ùå Failed to fetch. Remote is configured but fetch failed."
                exit 1
              fi
            }
            
            # –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ç–∫—É production
            TARGET_BRANCH="production"
            echo "Target branch: $TARGET_BRANCH"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ production –≤ remote
            if ! git ls-remote --heads origin production | grep -q production; then
              echo "‚ö†Ô∏è  Branch 'production' not found in remote repository"
              echo "Available remote branches:"
              git ls-remote --heads origin | sed 's/.*refs\/heads\///' || true
              echo ""
              echo "‚ùå Branch 'production' must exist in remote repository"
              exit 1
            fi
            
            git checkout production 2>/dev/null || git checkout -b production
            git reset --hard origin/production || {
              echo "‚ùå Failed to reset to origin/production"
              echo "Current branch: $(git branch --show-current)"
              exit 1
            }
            
            echo "Current commit: $(git log --oneline -1)"
            echo ""
            
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            echo "=== Installing dependencies ==="
            if [ -f "package.json" ]; then
              npm install || {
                echo "‚ùå Failed to install dependencies"
                exit 1
              }
              echo "‚úÖ Dependencies installed"
            else
              echo "‚ö†Ô∏è  package.json not found"
            fi
            echo ""
            
            # –°–±–æ—Ä–∫–∞ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            echo "=== Building application ==="
            if [ -f "package.json" ] && grep -q '"build"' package.json; then
              npm run build || {
                echo "‚ùå Build failed"
                exit 1
              }
              echo "‚úÖ Build completed"
            else
              echo "‚ö†Ô∏è  No build script found in package.json"
            fi
            echo ""
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
            echo "=== Restarting service ==="
            if systemctl restart aiternitas-main.service; then
              echo "‚úÖ Service restarted"
              sleep 2
              systemctl status aiternitas-main.service --no-pager | head -10 || true
            else
              echo "‚ö†Ô∏è  Service restart failed or service not found"
            fi
            echo ""
          EOSSH

      - name: Verify deployment
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        run: |
          set -e
          SSH_HOST="${{ env.SSH_HOST }}"
          SSH_USER="${{ env.SSH_USER }}"
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} <<'EOSSH'
            set -e
            
            echo "=== Aiternitas Main Service Status ==="
            systemctl status aiternitas-main.service --no-pager | head -10 || echo "Service not found"
            
            echo ""
            echo "=== Last Commit ==="
            cd /opt/aiternitas-main && git log --oneline -1 || echo "No commits yet"
            
            echo ""
            echo "=== Service Health ==="
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001 || echo "000")
            echo "Aiternitas Main HTTP status: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "‚úÖ Aiternitas Main service is responding"
            else
              echo "‚ö†Ô∏è Aiternitas Main service may not be responding correctly"
            fi
          EOSSH

      - name: Skip notice
        if: steps.secrets_check.outputs.skip_deploy == 'true'
        run: |
          echo "üîï Deployment skipped because SSH_PRIVATE_KEY secret is not configured."
