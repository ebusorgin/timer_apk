name: Deploy Conference to Production

on:
  push:
    branches:
      - master
      - main
      - production
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Conference to apk.aiternitas.ru
    runs-on: ubuntu-latest
    env:
      SSH_HOST: ${{ secrets.SERVER_HOST || '82.146.44.126' }}
      SSH_USER: ${{ secrets.SERVER_USER || 'root' }}
      SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      PERSISTENCE_DRIVER: postgres
      PGSSLMODE: disable

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check required secrets
        shell: bash
        run: |
          if [ -z "$SSH_KEY" ]; then
            echo "âš ï¸  SSH_PRIVATE_KEY secret is not set. Deployment steps will be skipped."
            echo "skip_deploy=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_deploy=false" >> "$GITHUB_OUTPUT"
          fi
        id: secrets_check

      - name: Setup SSH key
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy Conference
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        run: |
          set -e
          SSH_HOST="${{ env.SSH_HOST }}"
          SSH_USER="${{ env.SSH_USER }}"
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} <<'EOSSH'
            set -e
            
            REPO_DIR="/opt/conference"
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            if [ ! -d "$REPO_DIR" ]; then
              mkdir -p "$REPO_DIR"
              cd "$REPO_DIR"
              git init
              git remote add origin git@github.com:ebusorgin/conference.git || true
            fi
            
            cd "$REPO_DIR"
            git config --global --add safe.directory "$REPO_DIR" || true
            git fetch origin
            git checkout production || git checkout -b production
            git reset --hard origin/production
            
            # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
            if [ -f "package.json" ]; then
              npm install --production
            fi
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°
            systemctl restart conference.service || echo "Service conference.service not found, will be created"
            sleep 2
            systemctl status conference.service --no-pager | head -10 || true
            echo ""
          EOSSH

      - name: Verify deployment
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        run: |
          set -e
          SSH_HOST="${{ env.SSH_HOST }}"
          SSH_USER="${{ env.SSH_USER }}"
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} <<'EOSSH'
            set -e
            
            echo "=== Conference Service Status ==="
            systemctl status conference.service --no-pager | head -10 || echo "Service not found"
            
            echo ""
            echo "=== Last Commit ==="
            cd /opt/conference && git log --oneline -1 || echo "No commits yet"
            
            echo ""
            echo "=== Service Health ==="
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
            echo "Conference (3000) HTTP status: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Conference service is responding"
            else
              echo "âš ï¸ Conference service may not be responding correctly"
            fi
          EOSSH

      - name: Skip notice
        if: steps.secrets_check.outputs.skip_deploy == 'true'
        run: |
          echo "ðŸ”• Deployment skipped because SSH_PRIVATE_KEY secret is not configured."

