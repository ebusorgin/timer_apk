name: Deploy to Production Server

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  SERVER_HOST: 82.146.44.126
  SERVER_USER: root

jobs:
  deploy:
    name: Deploy to aiternitas.ru
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            export GIT_REPO_URL="${{ secrets.GIT_REPO_URL || 'https://github.com/ebusorgin/timer_apk.git' }}"
            BRANCH="${{ github.ref_name }}"
            
            # Создание директории и пользователя
            if ! id "voice-room" &>/dev/null; then
              useradd -r -s /bin/bash -d /opt/voice-room -m voice-room || true
            fi
            mkdir -p /opt/voice-room
            chown -R voice-room:voice-room /opt/voice-room || true
            
            # Клонирование или обновление репозитория
            cd /opt/voice-room
            if [ -d ".git" ]; then
              sudo -u voice-room git fetch origin || true
              sudo -u voice-room git reset --hard origin/$BRANCH || sudo -u voice-room git reset --hard origin/master || true
              sudo -u voice-room git clean -fd || true
            else
              rm -rf /opt/voice-room/*
              sudo -u voice-room git clone $GIT_REPO_URL .
            fi
            chown -R voice-room:voice-room /opt/voice-room
            
            # Выполнение скрипта настройки или деплоя
            if [ -f "deploy.sh" ]; then
              bash deploy.sh $BRANCH || bash deploy.sh master || bash deploy.sh main
            elif [ -f "server-setup.sh" ]; then
              bash server-setup.sh
            else
              # Минимальная настройка если скрипты отсутствуют
              sudo -u voice-room npm ci --production || sudo -u voice-room npm install --production || true
              cp nginx.conf /etc/nginx/sites-available/aiternitas.ru 2>/dev/null || true
              ln -sf /etc/nginx/sites-available/aiternitas.ru /etc/nginx/sites-enabled/ 2>/dev/null || true
              cp voice-room.service /etc/systemd/system/ 2>/dev/null || true
              systemctl daemon-reload || true
              systemctl restart voice-room || systemctl start voice-room || true
            fi
            
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            sleep 10
            # Проверка и установка systemd service если нужно
            if [ ! -f "/etc/systemd/system/voice-room.service" ]; then
              echo "⚠️ Service file not found, installing..."
              cd /opt/voice-room
              if [ -f "voice-room.service" ]; then
                cp voice-room.service /etc/systemd/system/
                systemctl daemon-reload
                systemctl enable voice-room || true
              fi
            fi
            
            # Проверка статуса сервиса
            if systemctl is-active --quiet voice-room; then
              echo "✅ Service is running"
              systemctl status voice-room --no-pager | head -10
            else
              echo "⚠️ Service not running, attempting to start..."
              systemctl start voice-room || systemctl restart voice-room || true
              sleep 5
              systemctl status voice-room --no-pager | head -20 || true
            fi
            
            # Проверка доступности приложения
            sleep 5
            if curl -f http://127.0.0.1:3000 > /dev/null 2>&1; then
              echo "✅ Application is accessible"
            else
              echo "⚠️ Application not responding, checking logs..."
              journalctl -u voice-room -n 30 --no-pager || true
              ps aux | grep node | grep -v grep || echo "No node process found"
              exit 1
            fi
            echo "✅ Deployment verified successfully"
            
      - name: Check SSL certificate
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            certbot certificates | grep aiternitas.ru || echo "⚠️  SSL certificate not found"
            nginx -t || exit 1
            echo "✅ Nginx configuration verified"

