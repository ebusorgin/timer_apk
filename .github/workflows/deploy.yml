name: Deploy to Production Server

on:
  push:
    branches:
      - master
      - main
      - production
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to aiternitas.ru
    runs-on: ubuntu-latest
    env:
      SSH_HOST: ${{ secrets.SERVER_HOST || '82.146.44.126' }}
      SSH_USER: ${{ secrets.SERVER_USER || 'root' }}
      SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      PERSISTENCE_DRIVER: postgres
      PGSSLMODE: disable

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check required secrets
        shell: bash
        run: |
          if [ -z "$SSH_KEY" ]; then
            echo "âš ï¸  SSH_PRIVATE_KEY secret is not set. Deployment steps will be skipped."
            echo "skip_deploy=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_deploy=false" >> "$GITHUB_OUTPUT"
          fi
        id: secrets_check

      - name: Setup SSH key
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy application
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        run: |
          set -e
          BRANCH="${{ github.ref_name }}"
          SSH_HOST="${{ env.SSH_HOST }}"
          SSH_USER="${{ env.SSH_USER }}"
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} <<'EOSSH'
            set -e
            
            # Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ°
            update_service() {
              local SERVICE_DIR=$1
              local SERVICE_NAME=$2
              
              echo "=== Updating $SERVICE_NAME ==="
              cd "$SERVICE_DIR"
              
              # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° git Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
              git config --global --add safe.directory "$SERVICE_DIR" || true
              
              # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð°
              git fetch origin
              git checkout production
              git reset --hard origin/production
              
              # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
              npm install --production
              
              # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°
              systemctl restart "$SERVICE_NAME"
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
              sleep 2
              systemctl status "$SERVICE_NAME" --no-pager | head -10
              echo ""
            }
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ð° ÑÐµÑ€Ð²Ð¸ÑÐ°
            update_service /opt/voice-room-test voice-room-test.service
            update_service /opt/voice-room voice-room.service
          EOSSH

      - name: Verify deployment
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        run: |
          set -e
          SSH_HOST="${{ env.SSH_HOST }}"
          SSH_USER="${{ env.SSH_USER }}"
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} <<'EOSSH'
            set -e
            
            echo "=== Service Status ==="
            echo "--- voice-room-test.service (port 3001) ---"
            systemctl status voice-room-test.service --no-pager | head -10
            echo ""
            echo "--- voice-room.service (port 3000) ---"
            systemctl status voice-room.service --no-pager | head -10
            
            echo ""
            echo "=== Last Commits ==="
            echo "--- voice-room-test ---"
            cd /opt/voice-room-test && git log --oneline -1
            echo "--- voice-room ---"
            cd /opt/voice-room && git log --oneline -1
            
            echo ""
            echo "=== Service Health ==="
            HTTP_CODE_3001=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001 || echo "000")
            HTTP_CODE_3000=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
            echo "voice-room-test (3001) HTTP status: $HTTP_CODE_3001"
            echo "voice-room (3000) HTTP status: $HTTP_CODE_3000"
            
            if [ "$HTTP_CODE_3001" = "200" ] && [ "$HTTP_CODE_3000" = "200" ]; then
              echo "âœ… Both services are responding"
            else
              echo "âš ï¸ Some services may not be responding correctly"
            fi
          EOSSH

      - name: Skip notice
        if: steps.secrets_check.outputs.skip_deploy == 'true'
        run: |
          echo "ðŸ”• Deployment skipped because SSH_PRIVATE_KEY secret is not configured."
          echo ""
          echo "To enable automatic deployment:"
          echo "1. Go to GitHub repository Settings > Secrets and variables > Actions"
          echo "2. Add secret named 'SSH_PRIVATE_KEY' with your private SSH key content"
          echo "3. The key should be: ~/.ssh/id_rsa_aiternitas"

