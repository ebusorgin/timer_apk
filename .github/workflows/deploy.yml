name: Deploy to Production Server

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to aiternitas.ru
    runs-on: ubuntu-latest
    env:
      SSH_HOST: ${{ secrets.SERVER_HOST || '82.146.44.126' }}
      SSH_USER: ${{ secrets.SERVER_USER || 'root' }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check required secrets
        shell: bash
        run: |
          if [ -z "$SSH_PASSWORD" ]; then
            echo "‚ö†Ô∏è  SSH_PASSWORD secret not set. Deployment steps will be skipped."
            echo "skip_deploy=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_deploy=false" >> "$GITHUB_OUTPUT"
          fi
        id: secrets_check

      - name: Deploy application
        uses: appleboy/ssh-action@v1.0.0
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: 22
          script: |
            set -e
            BRANCH="${{ github.ref_name }}"

            mkdir -p /opt/voice-room
            chown voice-room:voice-room /opt/voice-room || true

            sudo -u voice-room bash <<'EOS'
            set -e
            cd /opt/voice-room

            if [ -d .git ]; then
              git fetch origin
              git reset --hard origin/$BRANCH 2>/dev/null || git reset --hard origin/master
            else
              git clone https://github.com/ebusorgin/timer_apk.git .
              git checkout $BRANCH 2>/dev/null || git checkout master
            fi

            npm ci --production
            EOS

            systemctl restart voice-room || systemctl start voice-room

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        if: steps.secrets_check.outputs.skip_deploy == 'false'
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: 22
          script: |
            set -e

            systemctl status voice-room --no-pager | head -20

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L http://aiternitas.ru || echo "000")
            HTTPS_CODE=$(curl -s -o /dev/null -w "%{http_code}" -k -L https://aiternitas.ru || echo "000")

            echo "HTTP status: $HTTP_CODE"
            echo "HTTPS status: $HTTPS_CODE"

            if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "301" ] && [ "$HTTP_CODE" != "302" ]; then
              echo "‚ö†Ô∏è HTTP check failed"
            fi

            if [ "$HTTPS_CODE" != "200" ]; then
              echo "‚ö†Ô∏è HTTPS check failed"
            fi

      - name: Skip notice
        if: steps.secrets_check.outputs.skip_deploy == 'true'
        run: echo "üîï Deployment skipped because SSH secrets are not configured."

