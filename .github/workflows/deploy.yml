name: Deploy to Production Server

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  SERVER_HOST: 82.146.44.126
  SERVER_USER: root

jobs:
  deploy:
    name: Deploy to aiternitas.ru
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            export GIT_REPO_URL="${{ secrets.GIT_REPO_URL || 'https://github.com/ebusorgin/timer_apk.git' }}"
            BRANCH="${{ github.ref_name }}"
            
            # Создание директории и пользователя
            if ! id "voice-room" &>/dev/null; then
              useradd -r -s /bin/bash -d /opt/voice-room -m voice-room || true
            fi
            mkdir -p /opt/voice-room
            chown -R voice-room:voice-room /opt/voice-room || true
            
            # Клонирование или обновление репозитория
            cd /opt/voice-room
            if [ -d ".git" ]; then
              echo "Обновление существующего репозитория..."
              sudo -u voice-room git fetch origin || true
              sudo -u voice-room git reset --hard origin/$BRANCH || sudo -u voice-room git reset --hard origin/master || true
              sudo -u voice-room git clean -fd || true
            else
              echo "Клонирование нового репозитория..."
              rm -rf /opt/voice-room/* /opt/voice-room/.* 2>/dev/null || true
              sudo -u voice-room git clone $GIT_REPO_URL .
            fi
            chown -R voice-room:voice-room /opt/voice-room
            
            # Проверка наличия необходимых файлов
            echo "Проверка структуры проекта..."
            ls -la /opt/voice-room/ | head -20
            if [ ! -f "/opt/voice-room/server/server.mjs" ]; then
              echo "⚠️ server/server.mjs не найден! Проверяю структуру..."
              find /opt/voice-room -name "*.mjs" -o -name "server.mjs" | head -10
              echo "Содержимое директории:"
              ls -la /opt/voice-room/server/ 2>/dev/null || echo "Директория server не существует"
              exit 1
            fi
            echo "✅ Файл server/server.mjs найден"
            
            # Выполнение скрипта настройки или деплоя
            if [ -f "deploy.sh" ]; then
              bash deploy.sh $BRANCH || bash deploy.sh master || bash deploy.sh main
            elif [ -f "server-setup.sh" ]; then
              bash server-setup.sh
            else
              # Минимальная настройка если скрипты отсутствуют
              echo "Выполнение минимальной настройки..."
              sudo -u voice-room npm ci --production || sudo -u voice-room npm install --production || true
              
              # Настройка nginx
              if [ -f "nginx.conf" ]; then
                cp nginx.conf /etc/nginx/sites-available/aiternitas.ru
                ln -sf /etc/nginx/sites-available/aiternitas.ru /etc/nginx/sites-enabled/
                rm -f /etc/nginx/sites-enabled/default
                nginx -t && (systemctl start nginx || systemctl restart nginx || systemctl reload nginx) || true
              fi
              
              # Настройка systemd service
              if [ -f "voice-room.service" ]; then
                cp voice-room.service /etc/systemd/system/
                systemctl daemon-reload
                systemctl enable voice-room || true
                systemctl start voice-room || systemctl restart voice-room || true
              else
                echo "⚠️ voice-room.service не найден, создаю базовый..."
                printf '%s\n' '[Unit]' 'Description=Voice Room Application' 'After=network.target' '' '[Service]' 'Type=simple' 'User=voice-room' 'WorkingDirectory=/opt/voice-room' 'Environment="NODE_ENV=production"' 'Environment="PORT=3000"' 'Environment="HOST=127.0.0.1"' 'Environment="CORS_ORIGIN=https://aiternitas.ru"' 'EnvironmentFile=-/opt/voice-room/.env' 'ExecStart=/usr/bin/node server/server.mjs' 'Restart=always' 'RestartSec=10' 'StandardOutput=syslog' 'StandardError=syslog' 'SyslogIdentifier=voice-room' '' '[Install]' 'WantedBy=multi-user.target' > /etc/systemd/system/voice-room.service
                systemctl daemon-reload
                systemctl enable voice-room
                systemctl start voice-room || true
              fi
            fi
            
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            sleep 10
            # Проверка и установка systemd service если нужно
            if [ ! -f "/etc/systemd/system/voice-room.service" ]; then
              echo "⚠️ Service file not found, installing..."
              cd /opt/voice-room
              if [ -f "voice-room.service" ]; then
                cp voice-room.service /etc/systemd/system/
                systemctl daemon-reload
                systemctl enable voice-room || true
              else
                echo "⚠️ voice-room.service не найден в репозитории, создаю базовый..."
                printf '%s\n' '[Unit]' 'Description=Voice Room Application' 'After=network.target' '' '[Service]' 'Type=simple' 'User=voice-room' 'WorkingDirectory=/opt/voice-room' 'Environment="NODE_ENV=production"' 'Environment="PORT=3000"' 'Environment="HOST=127.0.0.1"' 'Environment="CORS_ORIGIN=https://aiternitas.ru"' 'EnvironmentFile=-/opt/voice-room/.env' 'ExecStart=/usr/bin/node server/server.mjs' 'Restart=always' 'RestartSec=10' 'StandardOutput=syslog' 'StandardError=syslog' 'SyslogIdentifier=voice-room' '' '[Install]' 'WantedBy=multi-user.target' > /etc/systemd/system/voice-room.service
                systemctl daemon-reload
                systemctl enable voice-room
              fi
            fi
            
            # Проверка статуса сервиса
            if systemctl is-active --quiet voice-room; then
              echo "✅ Service is running"
              systemctl status voice-room --no-pager | head -10
            else
              echo "⚠️ Service not running, attempting to start..."
              systemctl start voice-room || systemctl restart voice-room || true
              sleep 5
              systemctl status voice-room --no-pager | head -20 || true
            fi
            
            # Проверка доступности приложения
            sleep 5
            if curl -f http://127.0.0.1:3000 > /dev/null 2>&1; then
              echo "✅ Application is accessible"
            else
              echo "⚠️ Application not responding, checking logs..."
              journalctl -u voice-room -n 30 --no-pager || true
              ps aux | grep node | grep -v grep || echo "No node process found"
              echo "Проверка структуры проекта на сервере:"
              ls -la /opt/voice-room/ | head -20
              ls -la /opt/voice-room/server/ 2>/dev/null || echo "Директория server не существует"
              echo "Проверка файла:"
              test -f /opt/voice-room/server/server.mjs && echo "✅ server.mjs существует" || echo "❌ server.mjs НЕ существует"
              exit 1
            fi
            echo "✅ Deployment verified successfully"
            
      - name: Check SSL certificate
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            certbot certificates | grep aiternitas.ru || echo "⚠️  SSL certificate not found"
            nginx -t || exit 1
            echo "✅ Nginx configuration verified"

